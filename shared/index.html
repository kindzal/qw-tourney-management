<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?= appTitle ?></title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700|Droid+Sans+Mono|Roboto:500">

<style>
  body {
    font-family: 'Open Sans', Arial, sans-serif;
    margin: 20px;
  }

  /* Rank column emphasis */
  #players-output table th:first-child,
  #players-output table td:first-child {
    font-weight: 1000;
    text-align: center;
    border-right: 2px solid #c3d4f5;
  }

  #players-output table tbody tr:nth-child(1) td:first-child { color: #b8860b; }
  #players-output table tbody tr:nth-child(2) td:first-child { color: #6b7280; }
  #players-output table tbody tr:nth-child(3) td:first-child { color: #a16207; }

  /* Zebra striping */
  table tbody tr:nth-child(even) { background-color: #f1f4f9; }
  table tbody tr:nth-child(odd) { background-color: #ffffff; }
  table tbody tr:hover { background-color: #eef3ff; }

  section { display: none; margin-top: 20px; }
  section.active { display: block; }

  table {
    border-collapse: collapse;
    table-layout: auto;
    margin-top: 10px;
    width: max-content;
    max-width: 100%;
  }

  table th { white-space: normal; line-height: 1.2; }
  th { border: 1px solid #ccc; padding: 6px 10px; background: #eee; }
  td { border: 1px solid #ccc; padding: 6px 10px; white-space: nowrap; }
  .loading { color:#666; }

  .app-nav { margin-bottom: 16px; display:flex; gap:8px; flex-wrap:wrap; }
  .app-nav button {
    background: #f4f6f8;
    color: #333;
    border: 1px solid #c9ced6;
    border-radius: 6px;
    padding: 8px 14px;
    font-family: 'Roboto', 'Open Sans', Arial, sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .app-nav button:hover { background: #e9edf2; border-color: #b3bac4; }
  .app-nav button.active {
    background: #e8f4e8;
    border-color: #7db57d;
    color: #1f5f1f;
  }

  .app-logo { max-height:112px; max-width:201px; object-fit:contain; }
  .app-header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
  }
  .app-header-sub { display:flex; align-items:center; gap:14px; }
  .app-header h1 { margin: 0; }

  .wiki-link {
    display: inline-block;
    padding: 6px 12px;
    font-size: 0.9em;
    font-weight: 600;
    color: #0055aa;
    text-decoration: none;
    border: 1px solid #cdddee;
    border-radius: 4px;
    background: #f7faff;
    transition: background 0.15s ease, border-color 0.15s ease;
  }
  .wiki-link:hover { background: #eaf2ff; border-color: #99bbea; }

  h1, h2, h3, .round-header {
    font-family: 'Roboto', 'Open Sans', Arial, sans-serif;
    font-weight: 500;
  }

  /* ======================
     GROUP BRACKET (unchanged)
     ====================== */
  .bracket-wrapper {
    display: flex;
    flex-direction: column;
    gap: 32px;
    margin-top: 20px;
  }
  .round-block { display:flex; flex-direction:column; gap:12px; }
  .round-header { font-size: 1.2em; font-weight: bold; }
  .round-games {
    display: flex;
    gap: 40px;
    align-items: stretch;
    flex-wrap: nowrap;
  }

  /* Shared game card */
  .bracket-game {
    width: 280px;
    flex-shrink: 0;
  }
  .bracket-match {
    background:#fafafa;
    border:1px solid #ccc;
    padding:8px;
    border-radius:4px;
    position: relative;
  }
  .bracket-player {
    display:flex;
    justify-content:space-between;
    gap: 8px;
    padding:4px 6px;
    word-break: break-word;
  }
  .bracket-player.winner {
    font-weight:bold;
    background:#e8f4e8;
  }

  /* Pulse winner rows (optional flair) */
  @keyframes winnerPulse {
    0%   { box-shadow: 0 0 0 rgba(125,181,125,0.0); }
    50%  { box-shadow: 0 0 10px rgba(125,181,125,0.55); }
    100% { box-shadow: 0 0 0 rgba(125,181,125,0.0); }
  }
  .bracket-player.winner.advanced {
    animation: winnerPulse 1.8s ease-in-out infinite;
    border-radius: 3px;
  }

  .bracket-score {
    font-family: 'Droid Sans Mono', monospace;
    min-width: 24px;
    text-align: right;
  }
  .bracket-match.unplayed {
    background: #fff4f4;
    border-color: #e3b6b6;
  }
  .bracket-match.unplayed .bracket-player { opacity: 0.75; }
  .bracket-match.unplayed .bracket-score { font-weight: normal; }

  .info-icon {
    display:block;
    text-align:center;
    cursor:pointer;
    color:#0055aa;
    margin: 4px 0;
  }
  .info-icon.disabled {
    visibility: hidden;
    pointer-events: none;
  }

  /* Popup */
  .bracket-popup-wrapper {
    display:none;
    position:absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-170%);
    margin-top:6px;
    background:#fffefc;
    border:1px solid #bbb;
    border-radius:4px;
    padding:8px;
    z-index:100;
    min-width:280px;
    max-width:420px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  .bracket-popup-header {
    display:flex;
    justify-content:space-between;
    font-weight:bold;
    margin-bottom:6px;
    gap: 8px;
  }
  .bracket-popup-body-match {
    display:flex;
    align-items:center;
    gap: 8px;
    margin-bottom:4px;
  }
  .map-name {
    flex-grow:1;
    text-align:center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ======================
     PLAYOFFS
     ====================== */
  .playoffs-wrap {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 26px;
  }

  .playoffs-bracket {
    position: relative;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .playoffs-title {
    font-size: 1.1em;
    font-weight: 700;
    margin: 0 0 8px 0;
  }

  .stage-row {
    position: relative;
    display: flex;
    gap: 36px;
    align-items: flex-start;
    padding: 8px 4px 18px;
    min-width: 980px;
  }

  .stage-col {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }

  .stage-header {
    text-align: center;
    font-family: 'Roboto';
    font-weight: 500;
    margin-bottom: 4px;
    white-space: nowrap;
  }

  .stage-col .bracket-game { width: 280px; }

  .connector-layer {
    position:absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }
  .stage-row > * { position: relative; z-index: 1; }

  .bracket-winner {
    font-family: 'Roboto', 'Open Sans', Arial, sans-serif;
    font-weight: 700;
    font-size: 1.1em;
    padding: 10px 12px;
    border: 1px solid #e6d28a;
    background: #fff7d6;
    border-radius: 8px;
    width: fit-content;
  }

  /* ======================
     MOBILE
     ====================== */
  @media (max-width: 768px) {
    body { margin: 10px; font-size: 18px; }

    table { display:block; overflow-x:auto; }

    .round-games { flex-direction: column; gap: 16px; }
    .bracket-game { width: 100%; }

    .bracket-popup-wrapper {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }

    .stage-row {
      min-width: 0;
      flex-direction: column;
      gap: 16px;
    }
    .stage-col .bracket-game { width: 100%; }
    .connector-layer { display:none; }

    #players-output table:not(.show-all-cols) th:nth-child(n+9),
    #players-output table:not(.show-all-cols) td:nth-child(n+9) {
      display: none;
    }
    #players-output table.show-all-cols th,
    #players-output table.show-all-cols td {
      display: table-cell;
    }
    .players-toggle {
      display: block;
      margin: 8px 0 4px;
      font-size: 0.95em;
      font-weight: 600;
      color: #0055aa;
      background: none;
      border: none;
      padding: 6px 0;
      cursor: pointer;
    }
  }
</style>
</head>

<body>

<header class="app-header">
  <h1 class="app-title"><?= appTitle ?></h1>
  <div class="app-header-sub">
    <? if (logoUrl) { ?><img src="<?= logoUrl ?>" class="app-logo"><? } ?>
    <? if (wikiUrl) { ?>
      <a href="<?= wikiUrl ?>" target="_blank" rel="noopener" class="wiki-link">üìñ Wiki</a>
    <? } ?>
  </div>
</header>

<nav class="app-nav">
  <button data-target="standings">üèÜ Standings</button>
  <button data-target="teams">üë• Teams</button>
  <button data-target="players">üéØ Ranking</button>
  <button data-target="playoffs">üèÅ Playoffs</button>
</nav>

<section id="standings">
  <h2>Standings</h2>
  <div id="standings-output" class="loading">Loading‚Ä¶</div>
  <div id="team-games-output" class="loading">Loading‚Ä¶</div>
</section>

<section id="teams">
  <h2>Teams</h2>
  <div id="teams-output" class="loading">Loading‚Ä¶</div>
</section>

<section id="players">
  <h2>Players Ranking</h2>
  <div id="players-output" class="loading">Loading‚Ä¶</div>
</section>

<section id="playoffs">
  <h2>Playoffs</h2>
  <div id="playoffs-output" class="loading">Loading‚Ä¶</div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const baseUrl="<?= baseUrl ?>";
  const defaultPage="<?= defaultPage ?>";

  /* NAV */
  document.querySelectorAll(".app-nav button").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(btn.dataset.target).classList.add("active");
      document.querySelectorAll(".app-nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  const defaultBtn = document.querySelector(`.app-nav button[data-target="${defaultPage}"]`);
  if (defaultBtn) defaultBtn.click();

  /* TABLES */
  const PERCENT_COLUMNS=["Win Rate","Avg Eff","Avg SG","Avg LG"];

  function formatCell(h,v){
    if(PERCENT_COLUMNS.includes(h)){
      if(v==null||v==="") return "";
      if(typeof v==="string" && v.includes("%")) return v;
      const n=Number(v);
      return isNaN(n) ? v : ((n<=1?n*100:n).toFixed(0)+"%");
    }
    return v;
  }

  function renderTable(id,data){
    const c=document.getElementById(id);
    c.innerHTML="";
    if(!data?.length){ c.textContent="No data."; return; }
    const t=document.createElement("table");
    const h=Object.keys(data[0]);
    t.innerHTML="<thead><tr>"+h.map(x=>`<th>${x}</th>`).join("")+"</tr></thead>";
    const tb=document.createElement("tbody");
    data.forEach(r=>{
      const tr=document.createElement("tr");
      h.forEach(k=>{
        const td=document.createElement("td");
        td.textContent=formatCell(k,r[k]);
        if(!["Team","Player","Players"].includes(k)) td.style.textAlign="center";
        tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    c.appendChild(t);
  }

  fetch(baseUrl+"?endpoint=teams").then(r=>r.json()).then(d=>renderTable("teams-output",d));
  fetch(baseUrl+"?endpoint=standings").then(r=>r.json()).then(d=>renderTable("standings-output",d));

  fetch(baseUrl+"?endpoint=players")
    .then(r => r.json())
    .then(data => {
      renderTable("players-output", data);

      if (window.matchMedia("(max-width: 768px)").matches) {
        const container = document.getElementById("players-output");
        const table = container.querySelector("table");
        if (!table) return;

        const btn = document.createElement("button");
        btn.className = "players-toggle";
        btn.textContent = "Show more stats";

        btn.onclick = () => {
          const expanded = table.classList.toggle("show-all-cols");
          btn.textContent = expanded ? "Show fewer stats" : "Show more stats";
        };

        container.insertBefore(btn, table);
      }
    })
    .catch(e => {
      document.getElementById("players-output").textContent = "Error loading players: " + e;
    });

  /* ========= Shared: build a game card (group + playoffs) ========= */
  function buildGameCard(g, popupState) {
    const card = document.createElement("div");
    card.className = "bracket-game";

    const match = document.createElement("div");
    match.className = "bracket-match";
    if (!g.played) match.classList.add("unplayed");

    const a = document.createElement("div");
    const aWinner = Number(g.mapsWonA) > Number(g.mapsWonB);
    a.className = "bracket-player" + (aWinner ? " winner" : "");
    a.innerHTML = `<span>${g.teamA || ""}</span><span class="bracket-score">${g.mapsWonA ?? ""}</span>`;

    const b = document.createElement("div");
    const bWinner = Number(g.mapsWonB) > Number(g.mapsWonA);
    b.className = "bracket-player" + (bWinner ? " winner" : "");
    b.innerHTML = `<span>${g.teamB || ""}</span><span class="bracket-score">${g.mapsWonB ?? ""}</span>`;

    if (g.played) {
      if (aWinner) a.classList.add("advanced");
      if (bWinner) b.classList.add("advanced");
    }

    const info = document.createElement("span");
    if (g.played) {
      info.className = "info-icon";
      info.textContent = "‚ÑπÔ∏è";
    } else {
      info.className = "info-icon disabled";
      info.textContent = "‚ÑπÔ∏è";
    }

    const popup = document.createElement("div");
    popup.className = "bracket-popup-wrapper";
    popup.innerHTML = `<div class="bracket-popup-header"><div>${g.teamA || ""}</div><div>${g.teamB || ""}</div></div>`;

    (g.maps || []).forEach(m => {
      popup.innerHTML += `
        <div class="bracket-popup-body-match">
          <span class="bracket-score" style="font-weight:${m.teamAFrags>m.teamBFrags?'bold':'normal'}">${m.teamAFrags}</span>
          <a class="map-name" href="${m.gameUrl}" target="_blank" rel="noopener">${m.mapName}</a>
          <span class="bracket-score" style="font-weight:${m.teamBFrags>m.teamAFrags?'bold':'normal'}">${m.teamBFrags}</span>
        </div>`;
    });

    if (g.played) {
      info.onclick = (e) => {
        e.stopPropagation();
        if (popupState.openPopup && popupState.openPopup !== popup) {
          popupState.openPopup.style.display = "none";
        }
        popup.style.display = (popup.style.display === "block") ? "none" : "block";
        popupState.openPopup = (popup.style.display === "block") ? popup : null;
      };
    }

    match.append(a, info, b, popup);
    card.appendChild(match);
    return card;
  }

  /* ========= GROUP BRACKET (FIXED: numeric-only + sorted) ========= */
  const groupOut = document.getElementById("team-games-output");

  fetch(baseUrl+"?endpoint=groupGames").then(r=>r.json()).then(data=>{
    groupOut.innerHTML="";
    if(!data?.length){ groupOut.textContent="No matches."; return; }

    const rounds = {};

    data.forEach(g => {
      const rk = String(g.round ?? "").trim();
      if (!rk) return;
      if (isNaN(Number(rk))) return;
      (rounds[rk] ??= []).push(g);
    });

    const roundKeys = Object.keys(rounds).sort((a,b)=>Number(a)-Number(b));

    const wrapper = document.createElement("div");
    wrapper.className="bracket-wrapper";

    const popupState = { openPopup: null };
    document.addEventListener("click",()=>{ if(popupState.openPopup) popupState.openPopup.style.display="none"; popupState.openPopup=null; });

    roundKeys.forEach(round=>{
      const rb=document.createElement("div");
      rb.className="round-block";

      rb.innerHTML=`<div class="round-header">Round ${round}</div>`;
      const games=document.createElement("div");
      games.className="round-games";

      rounds[round].forEach(g=>{
        games.appendChild(buildGameCard(g, popupState));
      });

      rb.appendChild(games);
      wrapper.appendChild(rb);
    });

    groupOut.appendChild(wrapper);
  });

  /* ==========================
     PLAYOFFS
     ========================== */

  const playoffsOut = document.getElementById("playoffs-output");

  function isMobile() {
    return window.matchMedia("(max-width: 768px)").matches;
  }

  // FIX 2 & 3: no inferred pairing; only draw 1:1 connectors when counts permit
  function drawConnectors(stageRowEl, colEls, svgEl) {
    if (isMobile()) return;

    const rowRect = stageRowEl.getBoundingClientRect();
    svgEl.setAttribute("width", rowRect.width);
    svgEl.setAttribute("height", rowRect.height);

    while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);

    function centerRight(el) {
      const r = el.getBoundingClientRect();
      return { x: (r.right - rowRect.left), y: (r.top + r.height/2 - rowRect.top) };
    }
    function centerLeft(el) {
      const r = el.getBoundingClientRect();
      return { x: (r.left - rowRect.left), y: (r.top + r.height/2 - rowRect.top) };
    }

    for (let i=0; i<colEls.length-1; i++) {
      const fromGames = Array.from(colEls[i].querySelectorAll(".bracket-game"));
      const toGames   = Array.from(colEls[i+1].querySelectorAll(".bracket-game"));
      if (!fromGames.length || !toGames.length) continue;

      const n = Math.min(fromGames.length, toGames.length);

      for (let j=0; j<n; j++) {
        const fromEl = fromGames[j];
        const toEl   = toGames[j];
        if (!fromEl || !toEl) continue;

        const a = centerRight(fromEl);
        const b = centerLeft(toEl);

        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        const midX = (a.x + b.x) / 2;
        const d = `M ${a.x} ${a.y} C ${midX} ${a.y}, ${midX} ${b.y}, ${b.x} ${b.y}`;
        path.setAttribute("d", d);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#b8c0cc");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("opacity", "0.9");
        svgEl.appendChild(path);
      }
    }
  }

  // FIX 1: stronger normalization (trim + collapse whitespace + drop trailing " A")
  function normalizeStageName(name) {
    return String(name || "")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\s+A$/i, "");
  }

  function renderPlayoffsBracket(allGames) {
    playoffsOut.innerHTML = "";
    if (!allGames?.length) { playoffsOut.textContent = "No playoff games."; return; }

    // Group by normalized round label
    const byRound = {};
    allGames.forEach(g => {
      const r = normalizeStageName(g.round);
      (byRound[r] ??= []).push({ ...g, round: r });
    });

    const hasLosers =
      !!byRound["Semifinals B"]?.length ||
      !!byRound["Final B"]?.length ||
      !!byRound["Bronze B"]?.length;

    // FIX 4: trust API presence; only include stages that exist (single elim friendly)
    const winnersStages = ["Quarterfinals", "Semifinals", "Final", "Bronze"]
      .filter(stage => (byRound[stage]?.length ?? 0) > 0);

    const losersStages  = ["Semifinals B", "Final B", "Bronze B"]
      .filter(stage => (byRound[stage]?.length ?? 0) > 0);

    const expected = {
      "Quarterfinals": 4,
      "Semifinals": 2,
      "Final": 1,
      "Bronze": 1,
      "Semifinals B": 2,
      "Final B": 1,
      "Bronze B": 1
    };

    function padStage(stageName) {
      const list = (byRound[stageName] || []).slice();
      const want = expected[stageName] ?? list.length;

      while (list.length < want) {
        list.push({
          round: stageName,
          teamA: "",
          teamB: "",
          mapsWonA: "",
          mapsWonB: "",
          played: 0,
          maps: []
        });
      }
      return list;
    }

    const popupState = { openPopup: null };
    document.addEventListener("click",()=>{ if(popupState.openPopup) popupState.openPopup.style.display="none"; popupState.openPopup=null; });

    const wrap = document.createElement("div");
    wrap.className = "playoffs-wrap";

    function buildStageRow(title, stages) {
      const container = document.createElement("div");

      const h = document.createElement("div");
      h.className = "playoffs-title";
      h.textContent = title;
      container.appendChild(h);

      const bracket = document.createElement("div");
      bracket.className = "playoffs-bracket";

      const row = document.createElement("div");
      row.className = "stage-row";

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.classList.add("connector-layer");
      row.appendChild(svg);

      const cols = [];

      stages.forEach(stageName => {
        const col = document.createElement("div");
        col.className = "stage-col";

        const head = document.createElement("div");
        head.className = "stage-header";
        head.textContent = stageName;
        col.appendChild(head);

        const games = padStage(stageName);
        games.forEach(g => col.appendChild(buildGameCard(g, popupState)));

        cols.push(col);
        row.appendChild(col);
      });

      bracket.appendChild(row);
      container.appendChild(bracket);

      requestAnimationFrame(() => drawConnectors(row, cols, svg));
      window.addEventListener("resize", () => drawConnectors(row, cols, svg));

      return container;
    }

    if (winnersStages.length) {
      wrap.appendChild(buildStageRow("Winners Bracket", winnersStages));
    }

    // Winner label from Final
    const finalGame = (byRound["Final"] || [])[0];
    if (finalGame?.played) {
      const winnerName =
        Number(finalGame.mapsWonA) > Number(finalGame.mapsWonB) ? finalGame.teamA :
        Number(finalGame.mapsWonB) > Number(finalGame.mapsWonA) ? finalGame.teamB :
        "";
      if (winnerName) {
        const win = document.createElement("div");
        win.className = "bracket-winner";
        win.textContent = "üèÜ Winner: " + winnerName;
        wrap.appendChild(win);
      }
    }

    if (hasLosers && losersStages.length) {
      wrap.appendChild(buildStageRow("Losers Bracket", losersStages));
    }

    playoffsOut.appendChild(wrap);
  }

  fetch(baseUrl + "?endpoint=playoffGames")
    .then(r => r.json())
    .then(renderPlayoffsBracket)
    .catch(e => playoffsOut.textContent = "Error loading playoffs: " + e);

});
</script>

</body>
</html>
